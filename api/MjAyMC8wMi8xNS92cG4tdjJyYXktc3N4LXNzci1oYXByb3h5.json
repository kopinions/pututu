{"title":"如何科（ti）学（zi）冲浪（shangwang）","date":"2020-02-15T12:40:20.000Z","date_formatted":{"ll":"2020年2月15日","L":"2020/02/15","MM-DD":"02-15"},"link":"2020/02/15/vpn-v2ray-ssx-ssr-haproxy","tags":["ssr","v2ray"],"categories":["networks"],"updated":"2021-02-22T00:00:00.000Z","content":"<html><head></head><body><div id=\"content\">\n\n<div id=\"outline-container-orgc6e2303\" class=\"outline-2\">\n<h2 id=\"orgc6e2303\">如何科（ti）学（zi）冲浪（shangwang）</h2>\n<div class=\"outline-text-2\" id=\"text-orgc6e2303\">\n<p>\n作为一名资资深（加班很多）的程序员，在日常工作中遇到坑是非常常见的。本着我遇到的问题，90%以上的人肯定遇到过的原则。一般遇到我直接无法想出办法的场景，我一般是会直接上网搜索。在国内，排名前三的搜索引擎 baidu, bing, soso 谁用谁知道。此时不得不提的是一个前同事文章 <a href=\"https://mp.weixin.qq.com/s/o9SX1GSpt1e68DjoGIS9nQ\">不当伸手dang，从抛弃百度开始</a> 。百度不是一个搜索引擎，但是在国内，bing 也好不到哪里。是时候展示真正的技术了－－－ 搭梯子到外面看看。该篇文章，需要一定的基础（毕竟搭梯子是件技术活）。<br>\n</p>\n</div>\n\n\n<div id=\"outline-container-orgf9832e4\" class=\"outline-3\">\n<h3 id=\"orgf9832e4\">科（ti）学（zi）冲浪（shangwang）的原理</h3>\n<div class=\"outline-text-3\" id=\"text-orgf9832e4\">\n<p>\n很久很久以前我们上网的方式是这样的：<br>\n</p>\n\n\n<div id=\"orge02d92b\" class=\"figure\">\n<p><img src=\"/2020/02/15/vpn-v2ray-ssx-ssr-haproxy/original.png\"><br>\n</p>\n</div>\n\n<p>\n我们直接访问服务提供商，获取数据。服务提供商，直接将相关的数据发送给我们。没有中间商赚差价，这不就是很多人追求的嘛（哈哈哈哈哈）。当有了利益或者危<br>\n险的时候中间商就出现了。这种方式对于小朋友不友好啊，万一小朋友不小心看到了不该看的东西怎么办，我 dang 得为小朋友负责啊。所以我dang说，我要检查下你看得东<br>\n西，合适看的话，我再给你看。<br>\n</p>\n\n\n<p>\n我dang说要有墙（<a href=\"https://zh.wikipedia.org/wiki/%25E9%2598%25B2%25E7%2581%25AB%25E9%2595%25BF%25E5%259F%258E\">Great F1re Wa11</a>），于是便有了墙。<br>\n</p>\n\n\n<div id=\"org77d9b67\" class=\"figure\">\n<p><img src=\"/2020/02/15/vpn-v2ray-ssx-ssr-haproxy/gfw.png\"><br>\n</p>\n</div>\n\n<p>\n在这种情况下，我们的小朋友不能再随心所欲的访问他想访问的东西了，这可如何是好呢？这个需求是如此的强烈，小朋友怎么能忍呢。于是小朋友就用微信联系到了，<br>\n自己再国外的朋友。说我想访问下某个网站，麻烦你访问下，把内容打包下发给我啊。于是我们上网的方式就变成了如下所示。<br>\n</p>\n\n\n<div id=\"org6944450\" class=\"figure\">\n<p><img src=\"/2020/02/15/vpn-v2ray-ssx-ssr-haproxy/proxy.png\"><br>\n</p>\n</div>\n\n<ol class=\"org-ol\">\n<li>发微信给国外的小朋友，hi 还好吗（how are you）？<br></li>\n<li>Great F1re Wa11: 微信聊天信息，然后就把信息转发给了国外的小朋友<br></li>\n<li>国外的小朋友收到了GFW 转发的消息，知道是国内的朋友发送的消息。于是回复： hi, 我还好，你呢（Fine, thank you and you）<br></li>\n<li>Great F1re Wa11: 又是聊天，走你。小朋友：终于建立了一个微信的通道<br></li>\n<li>小朋友：麻烦帮我访问下 google, 然后把内容通过微信发给我。谢谢<br></li>\n<li>Great F1re Wa11: 又是聊天，走你。国外小朋友： 访问 google 啊，小意思<br></li>\n<li>国外小朋友：顺手就访问了谷歌<br></li>\n<li>国外小朋友：得到了 google 的内容<br></li>\n<li>国外小朋友：这是谷歌的内容，我给你打个压缩包，微信发给你。走你<br></li>\n<li>Great F1re Wa11: 又是微信聊天，继续走你。小朋友：哈哈，终于访问到 google 了<br></li>\n</ol>\n\n<p>\n通过微信这个通道完成了访问国外网站的需求。国外的小朋友即国外的host, 完成代理任务，访问内容，并且通过指定的通道返回内容。<br>\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-orgfd41dcc\" class=\"outline-3\">\n<h3 id=\"orgfd41dcc\">科学科（ti）学（zi）冲浪（shangwang）的方式</h3>\n<div class=\"outline-text-3\" id=\"text-orgfd41dcc\">\n</div>\n<div id=\"outline-container-orgf821b2a\" class=\"outline-4\">\n<h4 id=\"orgf821b2a\">购买服务（最简单）</h4>\n<div class=\"outline-text-4\" id=\"text-orgf821b2a\">\n<p>\n<a href=\"https://github.com/getlantern/download#%25E8%2593%259D%25E7%2581%25AFlantern%25E6%259C%2580%25E6%2596%25B0%25E7%2589%2588%25E6%259C%25AC%25E4%25B8%258B%25E8%25BD%25BD\">Lantern 蓝灯</a>：蓝灯可能是目前比较好用的免费VPN软件，其宣称采用P2P技术，如果全球有人使用了该软件，都可以作为代理服务端为他人服务<br>\n</p>\n</div>\n</div>\n\n<div id=\"outline-container-orgad8b365\" class=\"outline-4\">\n<h4 id=\"orgad8b365\">shadowsocks</h4>\n<div class=\"outline-text-4\" id=\"text-orgad8b365\">\n<p>\nshadowsocks 简称 SS, 是一种基于 <a href=\"https://zh.wikipedia.org/wiki/SOCKS#SOCK5\">SOCKS5</a> 代理方式的代理软件。shadowsocks 支持很多加密方式，可以使得数据包很难被防火墙识别，从而达到科学上网的目地。<br>\n原理图如下所示<br>\n</p>\n\n\n<div id=\"org8346b2b\" class=\"figure\">\n<p><img src=\"/2020/02/15/vpn-v2ray-ssx-ssr-haproxy/ss.png\"><br>\n</p>\n</div>\n</div>\n</div>\n\n<div id=\"outline-container-orga174473\" class=\"outline-4\">\n<h4 id=\"orga174473\">v2ray</h4>\n<div class=\"outline-text-4\" id=\"text-orga174473\">\n<p>\n提到 <a href=\"https://www.v2ray.com/\">v2ray</a> , 不得不说的是 Project V. Project V 是一些列工具的集合，它可以帮助你打造术语自己的专属基础通信网络. v2ray 就是这一系列工具中的核心工具，主要负责网络协议和功能的实现，与其他 Project V 进行通信. v2ray 有如下一些特性<br>\n</p>\n\n\n<ul class=\"org-ul\">\n<li>多入口多出口: 一个 V2Ray 进程可并发支持多个入站和出站协议，每个协议可独立工作。<br></li>\n<li>可定制化路由: 入站流量可按配置由不同的出口发出。轻松实现按区域或按域名分流，以达到最优的网络性能。<br></li>\n<li>多协议支持: V2Ray 可同时开启多个协议支持，包括 Socks、HTTP、Shadowsocks、VMess 等。每个协议可单独设置传输载体，比如 TCP、mKCP、WebSocket 等。<br></li>\n<li>隐蔽性: V2Ray 的节点可以伪装成正常的网站（HTTPS），将其流量与正常的网页流量混淆，以避开第三方干扰。<br></li>\n<li>反向代理: 通用的反向代理支持，可实现内网穿透功能。<br></li>\n<li>多平台支持: 原生支持所有常见平台，如 Windows、Mac OS、Linux，并已有第三方支持移动平台。<br></li>\n</ul>\n\n\n<p>\nv2ray 的原理跟 shandowsocks 很相似， 但是 v2ray 相对设计更加灵活。<br>\n</p>\n</div>\n</div>\n</div>\n\n<div id=\"outline-container-orgecfd87e\" class=\"outline-3\">\n<h3 id=\"orgecfd87e\">配置</h3>\n<div class=\"outline-text-3\" id=\"text-orgecfd87e\">\n<p>\n因为被qiang的厉害，所以我们采用如下的部署的结构<br>\n</p>\n\n\n<div id=\"org8f2b31b\" class=\"figure\">\n<p><img src=\"/2020/02/15/vpn-v2ray-ssx-ssr-haproxy/archi.png\"><br>\n</p>\n</div>\n\n\n<p>\n在此处我们使用 docker, docker-compose 来完成部署<br>\n</p>\n</div>\n\n<div id=\"outline-container-orgf6f8414\" class=\"outline-4\">\n<h4 id=\"orgf6f8414\">服务端</h4>\n<div class=\"outline-text-4\" id=\"text-orgf6f8414\">\n</div>\n<ul class=\"org-ul\">\n<li><a id=\"org7f652cc\"></a>docker-compose<br>\n<div class=\"outline-text-5\" id=\"text-org7f652cc\">\n<div class=\"org-src-container\">\n<figure class=\"highlight yaml\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">init:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">certbot/certbot</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">\"no\"</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/conf:/etc/letsencrypt</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/www:/var/www/certbot</span></span><br><span class=\"line\">      <span class=\"attr\">entrypoint:</span> <span class=\"string\">\"sh -c 'certbot certonly --webroot -w /var/www/certbot --email mail@doamin.com -d v.domain.com --rsa-key-size 4096 --agree-tos --force-renewal --non-interactive &amp;&amp; cat /etc/letsencrypt/live/v.domain.com/fullchain.pem /etc/letsencrypt/live/v.domain.com/privkey.pem &gt; /etc/letsencrypt/live/v.domain.com/v.haproxy.pem'\"</span></span><br><span class=\"line\">      <span class=\"attr\">certbot:</span></span><br><span class=\"line\">\t<span class=\"attr\">image:</span> <span class=\"string\">certbot/certbot</span></span><br><span class=\"line\">\t<span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">\t<span class=\"attr\">command:</span> []</span><br><span class=\"line\">\t<span class=\"attr\">volumes:</span></span><br><span class=\"line\">\t  <span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/conf:/etc/letsencrypt</span></span><br><span class=\"line\">\t  <span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/www:/var/www/certbot</span></span><br><span class=\"line\">\t  <span class=\"attr\">entrypoint:</span> <span class=\"string\">\"/bin/sh -c 'trap exit TERM; while :; do certbot renew &amp;&amp; cat /etc/letsencrypt/live/v.domain.com/fullchain.pem /etc/letsencrypt/live/v.domain.com/privkey.pem &gt; /etc/letsencrypt/live/v.domain.com/v.haproxy.pem; sleep 12h &amp; wait $${!}; done;'\"</span></span><br><span class=\"line\">\t  <span class=\"attr\">haproxy:</span></span><br><span class=\"line\">\t    <span class=\"comment\"># replace username/repo:tag with your name and image details</span></span><br><span class=\"line\">\t    <span class=\"attr\">image:</span> <span class=\"string\">haproxy</span></span><br><span class=\"line\">\t    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">\t    <span class=\"attr\">ports:</span></span><br><span class=\"line\">\t      <span class=\"bullet\">-</span> <span class=\"string\">\"443:443\"</span></span><br><span class=\"line\">\t      <span class=\"attr\">networks:</span></span><br><span class=\"line\">\t\t<span class=\"bullet\">-</span> <span class=\"string\">webnet</span></span><br><span class=\"line\">\t\t<span class=\"attr\">volumes:</span></span><br><span class=\"line\">\t\t  <span class=\"bullet\">-</span> <span class=\"string\">./data/haproxy:/usr/local/etc/haproxy/</span></span><br><span class=\"line\">\t\t  <span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/conf:/etc/letsencrypt</span></span><br><span class=\"line\">\t\t  <span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/www:/var/www/certbot</span></span><br><span class=\"line\">\t\t  <span class=\"attr\">command:</span> []</span><br><span class=\"line\">\t\t  <span class=\"attr\">v2ray:</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">image:</span> <span class=\"string\">v2ray/official</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">networks:</span></span><br><span class=\"line\">\t\t      <span class=\"bullet\">-</span> <span class=\"string\">webnet</span></span><br><span class=\"line\">\t\t      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">\t\t\t<span class=\"bullet\">-</span> <span class=\"string\">./data/v2ray/vmess/:/etc/v2ray/</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">command:</span> <span class=\"string\">\"\"</span></span><br><span class=\"line\">\t\t\t<span class=\"attr\">nginx:</span></span><br><span class=\"line\">\t\t\t  <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">\t\t\t  <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">\t\t\t  <span class=\"attr\">ports:</span></span><br><span class=\"line\">\t\t\t    <span class=\"bullet\">-</span> <span class=\"string\">\"80:80\"</span></span><br><span class=\"line\">\t\t\t    <span class=\"attr\">networks:</span></span><br><span class=\"line\">\t\t\t      <span class=\"bullet\">-</span> <span class=\"string\">webnet</span></span><br><span class=\"line\">\t\t\t      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">\t\t\t\t<span class=\"bullet\">-</span> <span class=\"string\">./data/nginx:/etc/nginx/conf.d</span></span><br><span class=\"line\">\t\t\t\t<span class=\"bullet\">-</span> <span class=\"string\">./data/certbot/www:/var/www/certbot</span></span><br><span class=\"line\">\t\t\t\t<span class=\"attr\">networks:</span></span><br><span class=\"line\">\t\t\t\t  <span class=\"attr\">webnet:</span></span><br><span class=\"line\">\t\t\t\t    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">\t\t\t\t      <span class=\"attr\">haproxy:</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"attr\">v2ray:</span></span><br></pre></td></tr></tbody></table></figure>\n</div>\n\n<p>\n通过共享 /data/certbot/www, 和 /data/certbot/conf 一边可以使用 certbot 来进行 let's encrypt 的验证，一遍生成证书。一边可以让 haproxy 来使用生成的证书。<br>\n</p>\n</div>\n</li>\n\n<li><a id=\"org4a3abaf\"></a>haproxy<br>\n<div class=\"outline-text-5\" id=\"text-org4a3abaf\">\n<div class=\"org-src-container\">\n<figure class=\"highlight ini\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">global</span><br><span class=\"line\">daemon</span><br><span class=\"line\">log stdout format raw daemon</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">defaults</span><br><span class=\"line\">log global</span><br><span class=\"line\">mode tcp</span><br><span class=\"line\">option tcplog</span><br><span class=\"line\"></span><br><span class=\"line\">option dontlognull</span><br><span class=\"line\"><span class=\"comment\">#maxconn 2000</span></span><br><span class=\"line\">timeout connect 24h</span><br><span class=\"line\">timeout client 24h</span><br><span class=\"line\">timeout server 24h</span><br><span class=\"line\"></span><br><span class=\"line\">frontend ssl</span><br><span class=\"line\">mode tcp</span><br><span class=\"line\">bind *:443 ssl crt /etc/letsencrypt/live/v.domain.com/v.haproxy.pem</span><br><span class=\"line\">tcp-request inspect-delay 5s</span><br><span class=\"line\"></span><br><span class=\"line\">use_backend v2ray if { ssl_fc_sni -i v.domain.com }</span><br><span class=\"line\">default_backend nginx</span><br><span class=\"line\"></span><br><span class=\"line\">backend v2ray</span><br><span class=\"line\">mode tcp</span><br><span class=\"line\">server v2ray v2ray:80</span><br><span class=\"line\"></span><br><span class=\"line\">backend nginx</span><br><span class=\"line\">mode tcp</span><br><span class=\"line\">server nginx nginx:80</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n</div>\n\n<p>\n通过 haproxy 来完成 443 端口的复用。使用 SNI (server name indicator) 的方式，来区分是走那一路协议，然后分发给不同的后端服务。默认使用 nginx 进行响应。<br>\n</p>\n</div>\n</li>\n\n<li><a id=\"org20caa93\"></a>v2ray<br>\n<div class=\"outline-text-5\" id=\"text-org20caa93\">\n<div class=\"org-src-container\">\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"attr\">\"log\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"loglevel\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"info\"</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"inbounds\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">80</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"vmess\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"clients\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"id\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"d314c65c-f70f-4e1d-91fa-46821204accc\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"alterId\"</span><span class=\"punctuation\">:</span> <span class=\"number\">64</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">}</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"streamSettings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"network\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"ws\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"wsSettings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"path\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"/v\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"headers\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">\"host\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"v.domain.com\"</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">}</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"outbounds\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"freedom\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n</div>\n\n<p>\n使用 websocket 的方式来进行服务。请将 v.domain.com 改为自己的地址<br>\n</p>\n</div>\n</li>\n\n<li><a id=\"org8991dce\"></a>nginx<br>\n<div class=\"outline-text-5\" id=\"text-org8991dce\">\n<div class=\"org-src-container\">\n<figure class=\"highlight ini\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">server {</span><br><span class=\"line\">listen 80 default_server<span class=\"comment\">;</span></span><br><span class=\"line\">server_name _<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">server_tokens off<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">location /.well-known/acme-challenge/ {</span><br><span class=\"line\">root /var/www/certbot<span class=\"comment\">;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\">location / {</span><br><span class=\"line\">proxy_pass https://domain.com<span class=\"comment\">;</span></span><br><span class=\"line\">}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n</div>\n\n<p>\nlocation <i><i>.well-known/acme-challenge</i></i> 被用来做 let's encrypt 做证书的验证。当 let's encrypt 验证的时候，使用 certbot 生成文件的内容，来完成验证。<br>\n</p>\n\n<p>\nlocation / 会默认的会使用网站的地址来响应。这样就会让 GFW 通过 IP 来访问的时候，得到的是我们的网站。从而不进行屏蔽。<br>\n</p>\n</div>\n</li>\n</ul>\n</div>\n<div id=\"outline-container-org87cd9a9\" class=\"outline-4\">\n<h4 id=\"org87cd9a9\">客户端</h4>\n<div class=\"outline-text-4\" id=\"text-org87cd9a9\">\n</div>\n<ul class=\"org-ul\">\n<li><a id=\"org89af94b\"></a>docker-compose<br>\n<div class=\"outline-text-5\" id=\"text-org89af94b\">\n<div class=\"org-src-container\">\n<figure class=\"highlight yaml\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">p  v2ray:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">v2ray/official</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"53:53\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"53:53/udp\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"1088:1088\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"1089:1089\"</span></span><br><span class=\"line\">      <span class=\"attr\">networks:</span></span><br><span class=\"line\">\t<span class=\"bullet\">-</span> <span class=\"string\">webnet</span></span><br><span class=\"line\">\t<span class=\"attr\">volumes:</span></span><br><span class=\"line\">\t  <span class=\"bullet\">-</span> <span class=\"string\">./data/v2ray/vmess/:/etc/v2ray/</span></span><br><span class=\"line\">\t  <span class=\"attr\">networks:</span></span><br><span class=\"line\">\t    <span class=\"attr\">webnet:</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n</div>\n</div>\n</li>\n\n<li><a id=\"org08b2812\"></a>v2ray<br>\n<div class=\"outline-text-5\" id=\"text-org08b2812\">\n<div class=\"org-src-container\">\n<figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"attr\">\"log\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"loglevel\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"info\"</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"dns\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"hosts\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"geosite:category-ads-all\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"127.0.0.1\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"servers\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"address\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"8.8.8.8\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">53</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"domains\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"geosite:geolocation-!cn\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"address\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"223.5.5.5\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">53</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"domains\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"geosite:cn\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"string\">\"localhost\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"inbounds\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">53</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"tag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"dns-in\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"dokodemo-door\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"address\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"8.8.8.8\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">53</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"network\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"tcp,udp\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">1088</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"socks\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"sniffing\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"enabled\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"destOverride\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">\"http\"</span><span class=\"punctuation\">,</span> <span class=\"string\">\"tls\"</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"auth\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"noauth\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"udp\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">1089</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"http\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"sniffing\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"enabled\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"allowTransparent\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"outbounds\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"vmess\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"vnext\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"address\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"v.domain.com\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">443</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"users\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">\"id\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"d314c65c-f70f-4e1d-91fa-46821204a41a\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">\"alterId\"</span><span class=\"punctuation\">:</span> <span class=\"number\">64</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">]</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">}</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"streamSettings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"network\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"ws\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"security\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"tls\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"wsSettings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"headers\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t\t    <span class=\"attr\">\"host\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"v.domain.com\"</span></span><br><span class=\"line\">\t\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"attr\">\"path\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"/v\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">}</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"tag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"proxy\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"mux\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"enabled\"</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"tag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"direct\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"freedom\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"tag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"dns-out\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"protocol\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"dns\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"settings\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"network\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"udp\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"address\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"8.8.8.8\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"port\"</span><span class=\"punctuation\">:</span> <span class=\"number\">53</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">\"routing\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t<span class=\"attr\">\"domainStrategy\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"IPIfNonMatch\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">\"rules\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"field\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"ip\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"8.8.8.8\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"outboundTag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"proxy\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"field\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"domain\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"geosite:cn\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"outboundTag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"direct\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"field\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"ip\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"223.5.5.5\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"outboundTag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"direct\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"field\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"outboundTag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"direct\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"ip\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"geoip:cn\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t\t<span class=\"string\">\"geoip:private\"</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">]</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"punctuation\">{</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"type\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"field\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"inboundTag\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"string\">\"dns-in\"</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t    <span class=\"attr\">\"outboundTag\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"dns-out\"</span></span><br><span class=\"line\">\t<span class=\"punctuation\">}</span></span><br><span class=\"line\">\t<span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">}</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n</div>\n</div>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n</body></html>","prev":{"title":"Verilog 笔记","link":"2020/02/15/verilog-tuturial"},"next":{"title":"Mesa meson 构建系统初探","link":"2020/02/12/meson"},"plink":"https://kopinions.com/2020/02/15/vpn-v2ray-ssx-ssr-haproxy/","toc":[{"id":"orgc6e2303","title":"如何科（ti）学（zi）冲浪（shangwang）","index":"1","children":[{"id":"orgf9832e4","title":"科（ti）学（zi）冲浪（shangwang）的原理","index":"1.1"},{"id":"orgfd41dcc","title":"科学科（ti）学（zi）冲浪（shangwang）的方式","index":"1.2"},{"id":"orgecfd87e","title":"配置","index":"1.3"}]}],"reading_time":"2139 字约 14 分钟"}